<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S√ÄN GIAO D·ªäCH CA HGS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f0f4f8; color: #1e293b; }
    .glass-card { background: white; border-radius: 1.25rem; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
    .btn-post { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; font-weight: 700; }
    .shift-badge { background: #eff6ff; color: #1e40af; padding: 4px 10px; border-radius: 8px; font-weight: 800; border: 1px solid #dbeafe; }
    .zalo-btn { background: #0068ff; color: white; border-radius: 8px; font-size: 0.75rem; font-weight: 700; padding: 6px 12px; display: inline-flex; align-items: center; gap: 4px; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-md mx-auto space-y-6">
    
    <header class="text-center">
      <h1 class="text-2xl font-black text-blue-700 uppercase italic">‚úàÔ∏è HGS SHIFT MARKET</h1>
      <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">S√†n trao ƒë·ªïi ca n·ªôi b·ªô</p>
    </header>

    <div class="glass-card p-6 space-y-4 border-t-4 border-t-blue-600">
      <h2 class="font-bold text-slate-800 flex items-center gap-2 underline decoration-blue-200 underline-offset-4">üìù ƒêƒÇNG TIN M·ªöI</h2>
      
      <div class="space-y-3">
        <select id="post-name" class="w-full p-3 bg-slate-50 border rounded-xl font-semibold outline-none focus:ring-2 ring-blue-500 text-sm"></select>
        
        <div class="grid grid-cols-2 gap-2">
          <select id="post-day" class="p-3 bg-slate-50 border rounded-xl text-sm font-medium outline-none">
            <option value="mon">Th·ª© Hai</option><option value="tue">Th·ª© Ba</option>
            <option value="wed">Th·ª© T∆∞</option><option value="thu">Th·ª© NƒÉm</option>
            <option value="fri">Th·ª© S√°u</option><option value="sat">Th·ª© B·∫£y</option>
            <option value="sun">Ch·ªß Nh·∫≠t</option>
          </select>
          <input id="post-shift" type="text" placeholder="M√£ ca ho·∫∑c Gi·ªù (VD: 08-12)" class="p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:border-blue-500">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <input id="post-price" type="text" placeholder="Gi√° ti·ªÅn (VD: 300k)" class="p-3 bg-slate-50 border rounded-xl text-sm outline-none focus:border-blue-500">
          <button onclick="setNegotiable()" class="text-[10px] font-bold text-blue-600 bg-blue-50 rounded-xl border border-blue-100 uppercase">Gi√° th∆∞∆°ng l∆∞·ª£ng</button>
        </div>

        <div class="relative">
          <span class="absolute left-3 top-3 opacity-40">üì±</span>
          <input id="post-zalo" type="tel" placeholder="S·ªë ƒëi·ªán tho·∫°i Zalo li√™n h·ªá" class="w-full p-3 pl-10 bg-slate-50 border rounded-xl text-sm outline-none">
        </div>

        <textarea id="post-note" placeholder="Ghi ch√∫ th√™m (V·ªã tr√≠, l√Ω do...)" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none" rows="2"></textarea>
        
        <button id="btn-post" class="w-full py-4 btn-post rounded-xl shadow-lg active:scale-95 transition-all">ƒêƒÇNG B√ÅN CA</button>
      </div>
    </div>

    <div class="space-y-4">
      <div class="flex justify-between items-center px-1">
        <h2 class="font-extrabold text-slate-700 text-sm uppercase">üî• Tin m·ªõi c·∫≠p nh·∫≠t</h2>
        <span id="count-tag" class="bg-blue-600 text-white text-[10px] font-black px-2 py-1 rounded-md">0 TIN</span>
      </div>
      
      <div id="market-list" class="space-y-4"></div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4">
      <div class="flex justify-between items-center">
        <h3 class="font-bold text-slate-800">üë• ƒê·ªìng ƒë·ªôi ƒëang r·∫£nh</h3>
        <button onclick="closeModal()" class="text-slate-400">‚úï</button>
      </div>
      <div id="suggest-list" class="max-h-72 overflow-y-auto space-y-2 pr-2"></div>
      <button onclick="closeModal()" class="w-full py-3 bg-slate-100 font-bold rounded-xl text-slate-600 text-sm">ƒê√£ hi·ªÉu</button>
    </div>
  </div>

<script>
// --- FIREBASE CONFIG (Gi·ªØ nguy√™n t·ª´ index9.html c·ªßa b·∫°n) ---
const firebaseConfig = {
  apiKey: "AIzaSyA2scrs8GpNAWZ5ETId6z3vkUMmArD1yn8",
  authDomain: "hgs36-6db0b.firebaseapp.com",
  databaseURL: "https://hgs36-6db0b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hgs36-6db0b",
  storageBucket: "hgs36-6db0b.firebasestorage.app",
  messagingSenderId: "356125658008",
  appId: "1:356125658008:web:aec521395459b2192579ed"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let employeeData = [];
const shifts={ HC:{start:7.5,end:15.5},A:{start:22,end:30},X:{start:14,end:22},S:{start:6,end:14} };

function setNegotiable() { document.getElementById('post-price').value = "Gi√° c·∫£ th∆∞∆°ng l∆∞·ª£ng"; }

// Logic x·ª≠ l√Ω gi·ªù t·ª´ m√£ ca ho·∫∑c chu·ªói gi·ªù t·ª± do
function parseShift(str){
    str=(str||"").toUpperCase().trim(); if(!str || str==="OFF" || str==="OM") return {start:0,end:0,dur:0};
    // N·∫øu nh·∫≠p d·∫°ng 08-12 ho·∫∑c 08:00-12:00
    if(str.includes("-") || str.includes(":")){
        const parts = str.split("-");
        if(parts.length === 2){
            const s = parseFloat(parts[0].replace(":","."));
            const e = parseFloat(parts[1].replace(":","."));
            if(!isNaN(s) && !isNaN(e)) return {start:s, end:e, dur: e-s};
        }
    }
    // Logic m√£ ca c≈© c·ªßa b·∫°n
    const re_fixed=/^(\d*\.?\d*-?)?(H|DH|M)(\d*\.?\d*)?(-?\d*\.?\d*)?$/; const m_f = re_fixed.exec(str);
    if(m_f){
        let d=8, s=8; if(m_f[2]==="DH"||m_f[2]==="M") d=parseFloat(m_f[3])||0;
        else if(m_f[2]==="H"){ if(m_f[3]) d=parseFloat(m_f[3]); if(/H4S/.test(str)) {s=8;d=4;} else if(/H4C/.test(str)){s=14;d=4;} }
        let e=s+d; if(m_f[1]){ const v=parseFloat(m_f[1].replace("-","")); m_f[1].includes("-")?s+=v:s-=v; }
        if(m_f[4]){ const v=parseFloat(m_f[4].replace("-","")); m_f[4].startsWith("-")?e-=v:e+=v; }
        return {start:s, end:e, dur: e-s};
    }
    const re=/^(\d*\.?\d*-?)?([A-Z]{1,2})(-?\d*\.?\d*)?$/; const m=re.exec(str);
    if(!m || !shifts[m[2]]) return {start:8, end:16, dur:8};
    let {start,end}=shifts[m[2]]; if(m[1]){ const v=parseFloat(m[1].replace("-","")); m[1].includes("-")?start+=v:start-=v; }
    if(m[3]){ const v=parseFloat(m[3].replace("-","")); m[3].startsWith("-")?end-=v:end+=v; }
    return {start, end, dur: end-start};
}

// ƒê·ªìng b·ªô danh s√°ch nh√¢n vi√™n
db.ref("hgs_data/employees").on("value", (snap) => {
    employeeData = snap.val() || [];
    const sel = document.getElementById("post-name");
    sel.innerHTML = '<option value="">-- Ch·ªçn t√™n b·∫°n --</option>';
    employeeData.sort((a,b)=>a.name.localeCompare(b.name)).forEach(e => {
        sel.innerHTML += `<option value="${e.name}">${e.name}</option>`;
    });
});

// Hi·ªÉn th·ªã tin ƒëƒÉng
db.ref("hgs_requests").on("value", (snap) => {
    const list = snap.val();
    const container = document.getElementById("market-list");
    container.innerHTML = "";
    if(!list) {
        container.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm italic">Ch∆∞a c√≥ ca n√†o ƒë∆∞·ª£c rao b√°n...</div>';
        return;
    }
    
    const entries = Object.entries(list).reverse();
    document.getElementById("count-tag").innerText = entries.length + " TIN";

    entries.forEach(([id, data]) => {
        const zaloHtml = data.zalo ? `<a href="https://zalo.me/${data.zalo}" target="_blank" class="zalo-btn">üí¨ Zalo: ${data.zalo}</a>` : '';
        container.innerHTML += `
            <div class="glass-card p-5 space-y-4 border-l-4 border-l-blue-600 relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">${data.name}</h3>
                        <p class="text-[10px] text-blue-600 font-black uppercase tracking-wider">${data.dayText}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-emerald-600 font-black text-sm">${data.price}</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200">
                    <div class="text-[10px] font-bold text-slate-400 uppercase leading-none">Ca c·∫ßn b√°n:</div>
                    <span class="shift-badge text-sm">${data.shiftCode}</span>
                </div>

                <p class="text-xs text-slate-500 font-medium italic">"${data.note || 'Kh√¥ng c√≥ ghi ch√∫ th√™m'}"</p>
                
                <div class="flex items-center justify-between pt-2 border-t border-slate-50">
                    ${zaloHtml}
                    <div class="flex gap-2">
                        <button onclick="findHelpers('${data.day}', '${data.shiftCode}')" class="p-2 bg-slate-100 rounded-lg text-blue-600 font-bold text-[10px] uppercase">T√¨m ng∆∞·ªùi r·∫£nh</button>
                        <button onclick="deletePost('${id}')" class="p-2 text-slate-300 hover:text-red-500">‚úï</button>
                    </div>
                </div>
            </div>
        `;
    });
});

// ƒêƒÉng tin m·ªõi
document.getElementById("btn-post").onclick = () => {
    const name = document.getElementById("post-name").value;
    const day = document.getElementById("post-day").value;
    const shiftCode = document.getElementById("post-shift").value;
    const price = document.getElementById("post-price").value;
    const zalo = document.getElementById("post-zalo").value;
    const note = document.getElementById("post-note").value;
    
    if(!name || !shiftCode || !price) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß: T√™n, Ca nh·ªù v√† Gi√°!");

    db.ref("hgs_requests").push({
        name, day, shiftCode, price, zalo, note,
        dayText: document.getElementById("post-day").options[document.getElementById("post-day").selectedIndex].text,
        timestamp: Date.now()
    }).then(() => {
        alert("ƒê√£ ƒëƒÉng tin th√†nh c√¥ng!");
        document.getElementById("post-shift").value = "";
        document.getElementById("post-price").value = "";
    });
};

function deletePost(id) { if(confirm("B·∫°n mu·ªën x√≥a tin n√†y?")) db.ref("hgs_requests").child(id).remove(); }

function findHelpers(dayKey, targetShiftStr) {
    const target = parseShift(targetShiftStr);
    const freePeople = [];

    employeeData.forEach(e => {
        const staffShiftStr = e[dayKey] || "OFF";
        const staffParts = staffShiftStr.split(";");
        let isBusy = false;

        staffParts.forEach(p => {
            const s = parseShift(p);
            if (s.dur > 0) {
                if (Math.max(target.start, s.start) < Math.min(target.end, s.end)) isBusy = true;
            }
        });
        if (!isBusy) freePeople.push({ name: e.name, shift: staffShiftStr });
    });

    const listDiv = document.getElementById("suggest-list");
    listDiv.innerHTML = freePeople.length ? "" : "<p class='text-center text-slate-400 py-4'>R·∫•t ti·∫øc, kh√¥ng c√≥ ai r·∫£nh...</p>";
    freePeople.forEach(p => {
        listDiv.innerHTML += `
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                <span class="font-bold text-slate-700 text-sm">${p.name}</span>
                <span class="text-[9px] font-black px-2 py-1 rounded bg-white border ${p.shift === 'OFF' ? 'text-emerald-500 border-emerald-100' : 'text-blue-400 border-blue-100'} uppercase">${p.shift}</span>
            </div>
        `;
    });
    document.getElementById("modal").classList.replace("hidden", "flex");
}

function closeModal() { document.getElementById("modal").classList.replace("flex", "hidden"); }
</script>
</body>
</html>